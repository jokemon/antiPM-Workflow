# [文件名称] PRD 验证报告

## 1. 执行摘要

**评分**: **需改进 (Needs Improvement)**

当前 PRD 为登录认证系统提供了清晰的基础框架，涵盖了账号冻结和重复登录检测等安全特性。然而，文档存在**关键逻辑缺失**：未定义“登出 (Logout)”机制，导致 `login_token` 在首次登录后无法被清除，“重复登录检测”功能因此无法闭环。此外，验证码的实现方式（前端 vs 后端）及 Token 的生命周期管理需要更明确的定义，以便 AI 能够准确生成代码。

## 2. 关键问题 (阻碍项)

| ID  | 类别                       | 问题描述                                                                                                                                                                        | 建议修复方案                                                                                      |
| :-- | :------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------ |
| 1   | 逻辑 (Logic)               | **缺失登出机制**: PRD 依赖 `login_token` 检测活跃会话，但未定义如何清除该 Token。若无登出功能，Token 只能保持非空状态，导致首次登录后的*每一次*登录都会错误触发“重复登录”警告。 | 增加 **登出 (Logout)** 章节：用户点击登出 -> 清除数据库中的 `login_token` -> 跳转回登录页。       |
| 2   | 逻辑 (Logic)               | **Token 更新逻辑闭环缺失**: 流程图在登录成功（S 或 R 节点）后，未明确指出系统需要生成*新的* UUID 并更新到数据库中。                                                             | 在成功路径中显式补充：生成新 UUID 作为 `login_token` 并写入数据库的操作步骤。                     |
| 3   | AI 可读性 (AI-Readability) | **验证码状态存储模糊**: “验证码超时”隐含了系统需知道生成时间。对于无状态的 HTTP 请求或纯前端原型，需明确时间戳存储位置（Session/LocalStore/DB）。                               | 明确指定实现方式。若是前端原型，建议：“在组件状态 (State) 中存储验证码结果与生成时间戳进行校验”。 |

## 3. 详细分析

### 3.1 AI 可读性 (AI-Readability)

- **优点**: 数据表定义规范，包含类型与默认值。Mermaid 流程图清晰展示了决策路径。
- **缺点**:
  - `login_token` 默认值为中文 "空"。AI 可能将其误解为字符串 "空"。**建议**: 明确标注为 `NULL` 或空字符串 `""`。
  - “占位图片区域”描述模糊。**建议**: 具体化为“左侧占据 50% 宽度，显示随机风景图片或纯色背景”。

### 3.2 行业标准与合理性 (Industry Standards)

- **安全性**:
  - **密码存储**: 测试数据使用“123456”且未提及哈希。**建议**: 增加说明“生产环境需使用 MD5/SHA256 哈希存储，原型可使用明文但需注明”。
  - **客户端验证**: 若数学验证码仅由 JS 校验，安全性较低。**建议**: 在文档中注明“本阶段仅做前端模拟验证”或要求“后端 API 校验”。

### 3.3 逻辑完整性 (Closed Loop Verification)

- **开环问题 (严重)**: 如关键问题所述，`login_token` 只有创建和检查，没有销毁（登出）过程。
- **流程连续性**: 流程图节点 `S` (登录成功) 直接指向 `End`。隐含了页面跳转逻辑，但明确写出“跳转至 Dashboard/主页”对 AI 更友好。

### 3.4 边界情况 (Edge Cases)

- **数学验证码**: "1-9" 随机加减。3 减 9 等于-6，负数是否允许？**建议**: 明确“结果需为非负整数”或“允许负数输入”。
- **数据库初始状态**: 需确保种子数据中 admin 账号的 `user_status` 显式设为 0（正常）。

### 3.5 UI/UX 一致性 (UI/UX Consistency)

- **提示语**: “旧账号已下线”是展示给*当前*正在登录的用户的。这在逻辑上是通的（通知当前用户他踢掉了别人），但通常措辞为“检测到其他设备在线，已将其踢下线”可能更准确。

## 4. 优化 Spec 提案

### 建议新增：登出功能模块 (在登录模块后)

#### 登出功能 (Logout)

- **触发动作**: 用户在主界面 (Dashboard) 点击顶部导航栏的 "退出登录" 按钮。
- **业务逻辑**:
  1.  **清除服务端状态**: API 请求将当前用户的 `login_token` 字段更新为 `NULL` 或空字符串。
  2.  **清除客户端状态**: 清除浏览器 `localStorage` 或 `sessionStorage` 中的用户信息。
  3.  **页面跳转**: 强制重定向回登录页面 (`login.html`)。

### 建议修改：登录成功后的 Token 逻辑

**原逻辑**:

> S --> T (重置错误计数)

**优化逻辑说明**:

> 1. **生成令牌**: 后端生成一个新的 UUID (v4) 字符串。
> 2. **更新记录**: SQL 执行 `UPDATE users SET login_token = 'new_uuid', last_login_time = NOW(), error_count = 0 WHERE id = user_id`.
> 3. **持久化**: 前端接收响应，将用户信息及 Token 存入 localStorage。
